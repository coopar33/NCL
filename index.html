<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pokémon Racing Simulator (Manual Stats + Special Moves)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    .container { background:#1f1f2f; color:#f8f8f8; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; padding:1.5rem; border-radius:12px; box-shadow:0 0 15px #0006; max-width:980px; margin:2rem auto; }
    h1 { color:#ffcb05; margin:0 0 1rem; text-shadow:0 0 10px #3b4cca; text-align:center; }
    h2 { margin:1.25rem 0 .5rem; color:#ffd84d; }
    .row { display:flex; flex-wrap:wrap; gap:1rem; }
    label { display:flex; flex-direction:column; gap:.35rem; flex:1 1 120px; font-weight:600; }
    select, input[type="number"], input[type="text"] { padding:.6rem .7rem; border-radius:8px; border:1px solid #333; background:#121222; color:#eaeaf5; }
    .actions { margin-top:1rem; display:flex; align-items:center; gap:1rem; }
    button { background:#3b4cca; color:#fff; border:none; padding:.7rem 1rem; border-radius:10px; cursor:pointer; font-weight:700; }
    button:hover { filter:brightness(1.1); }
    .error { color:#ff6b6b; font-weight:700; }
    table { width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:10px; }
    thead th { background:#2a2a3f; color:#e6e6ff; text-align:left; padding:.6rem .7rem; position:sticky; top:0; }
    tbody td { background:#17172a; border-top:1px solid #2a2a3f; padding:.6rem .7rem; }
    .results { margin-top:1.25rem; }
    details summary { cursor:pointer; margin:.75rem 0; }
    .breakdown { background:#121222; border:1px solid #2a2a3f; border-radius:10px; padding:1rem; margin:.75rem 0; }
    .chip { display:inline-block; background:#2a2a3f; color:#cfd3ff; padding:.2rem .5rem; border-radius:999px; font-size:.85rem; margin:.15rem .25rem 0 0; }
    .remove-btn { background:#8a1c1c; }
    .remove-btn:hover { filter:brightness(1.1); }
    .move-desc { font-size:.9em; color:#aaa; font-weight:400; margin-top:0.1rem; }
  </style>
</head>
<body>
<div class="race-sim container">
  <h1>Pokémon Racing Simulator</h1>

  <div class="race-controls">
    <div class="row">
      <label>
        Race Class
        <select id="raceClass">
          <option>Sprinter</option>
          <option>Stamina</option>
          <option>Mixed</option>
        </select>
      </label>
      <label>
        Terrain
        <select id="terrain">
          <option>Grass</option>
          <option>Mud</option>
          <option>Sand</option>
          <option>Snow</option>
          <option>Stone</option>
          <option>Urban</option>
        </select>
      </label>
      <label>
        Weather
        <select id="weather">
          <option>Clear</option>
          <option>Rain</option>
          <option>Hail</option>
          <option>Sun</option>
          <option>Fog</option>
        </select>
      </label>
    </div>

    <div class="racer-add">
      <h2>Add Racer (Manual Stats)</h2>
      <div class="row">
        <label>
          Name
          <input type="text" id="pokeName" placeholder="Pokémon or Racer Name" maxlength="24">
        </label>
        <label>
          HP
          <input type="number" id="hp" min="1" max="255" placeholder="e.g. 80">
        </label>
        <label>
          Atk
          <input type="number" id="atk" min="1" max="200" placeholder="e.g. 100">
        </label>
        <label>
          Def
          <input type="number" id="def" min="1" max="200" placeholder="e.g. 80">
        </label>
        <label>
          Sp. Atk
          <input type="number" id="spAtk" min="1" max="200" placeholder="e.g. 80">
        </label>
        <label>
          Sp. Def
          <input type="number" id="spDef" min="1" max="200" placeholder="e.g. 80">
        </label>
        <label>
          Speed
          <input type="number" id="speed" min="1" max="200" placeholder="e.g. 100">
        </label>
        <label>
          Rider Skill (0–12)
          <input type="number" id="riderSkill" min="0" max="12" value="6">
        </label>
        <label>
          Special Move / Ability
          <select id="specialMove">
            <option value="">N/A</option>
            <option value="Flame Charge">Flame Charge: +3 Speed for final sprint if used mid-race</option>
            <option value="Stamina">Stamina (Ability): Grants a free Stamina point on failed saves</option>
            <option value="Agility">Agility: Increases Focus for the obstacle phase by +4</option>
            <option value="Swift Swim / Chlorophyll">Swift Swim / Chlorophyll: Doubles Speed under matching weather</option>
          </select>
          <span class="move-desc" id="moveDesc"></span>
        </label>
      </div>
      <button id="addRacerBtn" type="button">Add Racer</button>
    </div>

    <div class="racer-list">
      <h2>Racers</h2>
      <table id="racerTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>HP</th>
            <th>Atk</th>
            <th>Def</th>
            <th>SpA</th>
            <th>SpD</th>
            <th>Spe</th>
            <th>Rider Skill</th>
            <th>Move/Ability</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="actions">
      <button id="runRaceBtn" type="button">Run Race</button>
      <span id="errorMsg" class="error" aria-live="polite"></span>
    </div>
  </div>

  <div id="results" class="results" style="display:none;">
    <h2>Race Results</h2>
    <table id="resultsTable">
      <thead>
        <tr>
          <th>Place</th>
          <th>Name</th>
          <th>Total Score</th>
          <th>Start (Focus)</th>
          <th>Mid (3 rolls)</th>
          <th>Event</th>
          <th>Final Sprint</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <details id="breakdowns">
      <summary>Show Detailed Breakdowns</summary>
      <div id="breakdownBlocks"></div>
    </details>
  </div>
</div>

<script>
  var terrains = [ "Grass", "Mud", "Sand", "Snow", "Stone", "Urban" ];
  var weathers = [ "Clear", "Rain", "Hail", "Sun", "Fog" ];

  var raceClasses = {
    Sprinter: { weight:{ Speed:1.5, Stamina:0.7, Focus:0.8 } },
    Stamina:  { weight:{ Speed:0.8, Stamina:1.5, Focus:0.9 } },
    Mixed:    { weight:{ Speed:1.0, Stamina:1.0, Focus:1.0 } }
  };

  // If you want, you can add synergy rules here as in the previous version

  var racers = [];

  // Moves/abilities info for tooltips and logic
  var moveInfo = {
    "": { desc: "No special move or ability." },
    "Flame Charge": { desc: "+3 Speed for final sprint if used mid-race", effect: "flameCharge" },
    "Stamina": { desc: "Grants a free Stamina point on failed saves", effect: "staminaAbility" },
    "Agility": { desc: "Increases Focus for the obstacle phase by +4", effect: "agility" },
    "Swift Swim / Chlorophyll": { desc: "Doubles Speed under matching weather", effect: "weatherBoost" }
  };

  function calcRacingStats(base) {
    return {
      Speed: base.speed,
      Stamina: base.hp + (base.def / 2),
      Focus: base.spDef + (base.atk / 2)
    };
  }

  function d20(){ return Math.floor(Math.random()*20+1); }

  function byId(id){ return document.getElementById(id); }

  function renderRacers() {
    var tbody = byId("racerTable").querySelector("tbody");
    tbody.innerHTML = "";
    for (var i=0;i<racers.length;i++){
      var r = racers[i];
      var tr = document.createElement("tr");
      tr.innerHTML =
        '<td>' + (i+1) + '</td>' +
        '<td>' + r.name + '</td>' +
        '<td>' + r.base.hp + '</td>' +
        '<td>' + r.base.atk + '</td>' +
        '<td>' + r.base.def + '</td>' +
        '<td>' + r.base.spAtk + '</td>' +
        '<td>' + r.base.spDef + '</td>' +
        '<td>' + r.base.speed + '</td>' +
        '<td>' + r.riderSkill + '</td>' +
        '<td>' + (r.move ? r.move : '—') + '</td>' +
        '<td><button type="button" class="remove-btn" data-index="'+i+'">Remove</button></td>';
      tbody.appendChild(tr);
    }
    var buttons = tbody.querySelectorAll(".remove-btn");
    for (var j=0;j<buttons.length;j++){
      buttons[j].addEventListener("click", function(ev){
        var idx = parseInt(ev.currentTarget.getAttribute("data-index"),10);
        racers.splice(idx,1);
        renderRacers();
      });
    }
  }

  function runRace() {
    var err = byId("errorMsg");
    err.textContent = "";
    if (racers.length < 2){
      err.textContent = "Need at least two racers!";
      return;
    }

    var className = byId("raceClass").value;
    var terrain   = byId("terrain").value;
    var weather   = byId("weather").value;
    var classMod  = raceClasses[className];

    var results = [];
    for (var i=0;i<racers.length;i++){
      var r = racers[i];
      var stats = calcRacingStats(r.base);
      var weighted = { Speed:0, Stamina:0, Focus:0 };
      weighted.Speed   = stats.Speed   * classMod.weight.Speed;
      weighted.Stamina = stats.Stamina * classMod.weight.Stamina;
      weighted.Focus   = stats.Focus   * classMod.weight.Focus;

      // Rider bonus
      var riderBonus = 0;
      if (r.riderSkill >= 10) riderBonus = 2;
      else if (r.riderSkill >= 7) riderBonus = 1;
      else if (r.riderSkill <= 2) riderBonus = -2;

      // Special Move/Ability logic flags
      var moveKey = r.move || "";
      var moveEff = (moveInfo[moveKey] && moveInfo[moveKey].effect) ? moveInfo[moveKey].effect : null;
      var moveSynergyNote = [];

      // Weather/terrain boost for Swift Swim / Chlorophyll
      if (
        moveEff === "weatherBoost" &&
        ((weather === "Rain" && r.move === "Swift Swim / Chlorophyll") ||
         (weather === "Sun" && r.move === "Swift Swim / Chlorophyll"))
      ) {
        weighted.Speed *= 2;
        moveSynergyNote.push("Speed doubled for weather");
      }

      // Start Phase: Focus roll
      var focusRoll = d20() + Math.floor(weighted.Focus / 20) + riderBonus;
      var speedPenalty = 0;
      if (focusRoll < 15) speedPenalty = -5;
      if (focusRoll < 10) speedPenalty = -10;

      // Mid-race Phase: Speed roll, Stamina loss
      var staminaLeft = weighted.Stamina;
      var speedRolls = [];
      var staminaAbilityUsed = false;
      for (var t = 0; t < 3; t++) {
        var speed = d20() + Math.floor(weighted.Speed / 10) + speedPenalty;
        speedRolls.push(speed);

        staminaLeft -= 1;
        // Stamina Ability: Grants a free Stamina point on failed save (if stamina drops below 30%)
        if (moveEff === "staminaAbility" && staminaLeft < weighted.Stamina * 0.3 && !staminaAbilityUsed) {
          staminaLeft += 1;
          staminaAbilityUsed = true;
          moveSynergyNote.push("+1 Stamina for Stamina Ability");
        }
        if (staminaLeft < weighted.Stamina * 0.3) speedPenalty -= 2;
      }
      var midSpeed = (speedRolls[0] + speedRolls[1] + speedRolls[2]) / 3;

      // Event Phase: Obstacle/Weather
      var eventPenalty = 0;
      var eventRoll = d20() + Math.floor(weighted.Focus / 20) + riderBonus;
      // Agility: +4 Focus for obstacle phase
      if (moveEff === "agility") {
        eventRoll += 4;
        moveSynergyNote.push("+4 Focus for obstacle phase");
      }
      if (eventRoll < 12) eventPenalty = -3;

      // Final Sprint: Speed roll, stamina mod
      var finalSprint = d20() + Math.floor(weighted.Speed / 10) + Math.floor(staminaLeft / 10);
      if (moveEff === "flameCharge") {
        finalSprint += 3;
        moveSynergyNote.push("+3 Speed for Flame Charge");
      }
      finalSprint += speedPenalty + eventPenalty;

      var totalScore = midSpeed + finalSprint;

      results.push({
        name: r.name,
        totalScore: totalScore,
        breakdown: {
          focusRoll: focusRoll,
          speedRolls: speedRolls,
          eventRoll: eventRoll,
          finalSprint: finalSprint,
          synergy: moveSynergyNote,
          weights: { Speed: weighted.Speed, Stamina: weighted.Stamina, Focus: weighted.Focus },
          riderBonus: riderBonus,
          terrain: terrain,
          weather: weather,
          className: className,
          move: r.move
        }
      });
    }

    results.sort(function(a,b){ return b.totalScore - a.totalScore; });

    var resTblBody = byId("resultsTable").querySelector("tbody");
    resTblBody.innerHTML = "";
    for (var rI=0;rI<results.length;rI++){
      var rr = results[rI];
      var tr = document.createElement("tr");
      tr.innerHTML =
        '<td>' + (rI+1) + '</td>' +
        '<td>' + rr.name + '</td>' +
        '<td>' + rr.totalScore.toFixed(1) + '</td>' +
        '<td>' + rr.breakdown.focusRoll + '</td>' +
        '<td>[' + rr.breakdown.speedRolls.map(function(x){return Math.round(x);}).join(', ') + ']</td>' +
        '<td>' + rr.breakdown.eventRoll + '</td>' +
        '<td>' + Math.round(rr.breakdown.finalSprint) + '</td>';
      resTblBody.appendChild(tr);
    }

    var blocks = byId("breakdownBlocks");
    blocks.innerHTML = "";
    for (var k=0;k<results.length;k++){
      var bk = results[k];
      var div = document.createElement("div");
      div.className = "breakdown";
      var chips = '';
      if (bk.breakdown.synergy && bk.breakdown.synergy.length){
        for (var s=0;s<bk.breakdown.synergy.length;s++){
          chips += '<span class="chip">' + bk.breakdown.synergy[s] + '</span>';
        }
      } else {
        chips += '<span class="chip">No special move bonus</span>';
      }
      chips += '<span class="chip">Class: ' + bk.breakdown.className + '</span>';
      chips += '<span class="chip">Terrain: ' + bk.breakdown.terrain + '</span>';
      chips += '<span class="chip">Weather: ' + bk.breakdown.weather + '</span>';
      chips += '<span class="chip">Rider Bonus: ' + bk.breakdown.riderBonus + '</span>';
      if (bk.breakdown.move)
        chips += '<span class="chip">Move: ' + bk.breakdown.move + '</span>';

      div.innerHTML =
        '<h3 style="margin:0 0 .25rem;">' + bk.name + '</h3>' +
        chips +
        '<div style="margin-top:.5rem;">' +
        '<strong>Weighted Stats</strong>: ' +
        'Speed ' + Math.round(bk.breakdown.weights.Speed) + ', ' +
        'Stamina ' + Math.round(bk.breakdown.weights.Stamina) + ', ' +
        'Focus ' + Math.round(bk.breakdown.weights.Focus) +
        '</div>' +
        '<div><strong>Start (Focus)</strong>: ' + bk.breakdown.focusRoll + '</div>' +
        '<div><strong>Mid (3 rolls)</strong>: [' + bk.breakdown.speedRolls.map(function(x){return Math.round(x);}).join(', ') + ']</div>' +
        '<div><strong>Event</strong>: ' + bk.breakdown.eventRoll + '</div>' +
        '<div><strong>Final Sprint</strong>: ' + Math.round(bk.breakdown.finalSprint) + '</div>' +
        '<div style="margin-top:.25rem;"><strong>Total Score</strong>: ' + bk.totalScore.toFixed(1) + '</div>';
      blocks.appendChild(div);
    }

    byId("results").style.display = "block";
  }

  // Show move/ability description
  byId("specialMove").addEventListener("change", function(){
    var moveKey = this.value || "";
    byId("moveDesc").textContent = moveInfo[moveKey] ? moveInfo[moveKey].desc : "";
  });

  (function init(){
    renderRacers();

    byId("addRacerBtn").addEventListener("click", function(){
      var name = byId("pokeName").value.trim();
      var hp = parseInt(byId("hp").value, 10);
      var atk = parseInt(byId("atk").value, 10);
      var def = parseInt(byId("def").value, 10);
      var spAtk = parseInt(byId("spAtk").value, 10);
      var spDef = parseInt(byId("spDef").value, 10);
      var speed = parseInt(byId("speed").value, 10);
      var skill = parseInt(byId("riderSkill").value, 10);
      var move = byId("specialMove").value || "";

      if (!name || isNaN(hp) || isNaN(atk) || isNaN(def) || isNaN(spAtk) || isNaN(spDef) || isNaN(speed)) {
        byId("errorMsg").textContent = "Please fill in all stat fields with valid numbers.";
        return;
      }
      if (isNaN(skill) || skill < 0 || skill > 12) {
        byId("errorMsg").textContent = "Rider Skill must be between 0 and 12.";
        return;
      }
      racers.push({
        name: name,
        base: { hp: hp, atk: atk, def: def, spAtk: spAtk, spDef: spDef, speed: speed },
        riderSkill: skill,
        move: move
      });
      byId("pokeName").value = "";
      byId("hp").value = "";
      byId("atk").value = "";
      byId("def").value = "";
      byId("spAtk").value = "";
      byId("spDef").value = "";
      byId("speed").value = "";
      byId("specialMove").value = "";
      byId("moveDesc").textContent = "";
      byId("errorMsg").textContent = "";
      renderRacers();
    });

    byId("runRaceBtn").addEventListener("click", runRace);
  })();
</script>
</body>
</html>
